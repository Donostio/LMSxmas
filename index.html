<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LMS Christmas Fair â€” Volunteer sign-up</title>
<style>
  :root{
    --bg:#f8f9fb; --card:#fff; --text:#222; --muted:#6c757d;
    --accent:#3498db; --accent-wait:#7f8c8d; --good:#2ecc71; --danger:#e03131; --badge:#f5f7fa;
    --primary:#e53935; /* big red Confirm button */
  }
  *{ box-sizing:border-box; }
  body{ margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width:1160px; margin:24px auto; padding:0 16px; }
  .card{ background:var(--card); border:1px solid #e6ebf1; border-radius:16px; padding:16px; }
  h1{ font-size:28px; margin:0 0 6px; }
  .muted{ color:var(--muted); }
  .row{ display:grid; grid-template-columns: 1fr; gap:16px; }
  @media(min-width:1100px){ .row{ grid-template-columns: 2fr 1fr; } }
  .filters{ display:flex; gap:16px; align-items:flex-start; }
  .filters .left{ flex: 1 1 auto; min-width:260px; }
  .filters .right{ flex: 1 1 40%; min-width:260px; }
  @media(max-width: 720px){
    .filters{ flex-direction:column; }
    .filters .right{ width:100%; }
  }
  label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
  select, input, button, .chip{ font:inherit; }
  select, input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:var(--badge); transition: border-color .15s, background .15s; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ecf5fc; border:1px solid #d1e9ff; color:#1877c9; cursor:pointer; user-select:none; }
  .chip.active{ background:#d1e9ff; }
  .timeHeader{ margin:12px 0 6px; font-weight:700; color:#334155; }
  .slots{ display:flex; flex-direction:column; gap:12px; min-height:60px; }
  .toolbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .toolbar .right{ display:flex; gap:12px; align-items:center; }
  .slot{ display:grid; grid-template-columns: 1fr 300px; gap:12px; padding:12px; border:1px solid #e6ebf1; border-radius:14px; background:var(--card); align-items:center; width:100%; }
  @media(max-width: 640px){
    .slot{ grid-template-columns: 1fr; }
  }
  .badge{ background:#f4faf6; border:1px solid #d6eade; border-radius:12px; padding:6px 10px; text-align:center; white-space:nowrap; }
  .panel{ display:flex; flex-direction:column; gap:8px; }
  .progress{ height:14px; background:var(--badge); border:1px solid #e6ebf1; border-radius:10px; overflow:hidden; }
  .bar{ height:100%; background:var(--good); width:0%; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  @media(max-width: 640px){ .grid2{ grid-template-columns: 1fr; } }
  ul{ margin:6px 0 0; padding-left:1rem; }
  .error{ color:var(--danger); font-weight:600; }
  .help{ font-size:12px; color:var(--muted); }
  .req::after{ content:" *"; color:var(--danger); font-weight:700; }
  .btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; transition:background .2s, opacity .2s; }
  .btn.selected{ background:#1f7cc7; }
  .btn.wait{ background:var(--accent-wait); opacity:.85; }
  .btn-primary{ background:var(--primary); font-weight:700; padding:14px 18px; font-size:18px; border-radius:14px; }
  .loading{ padding:16px; font-weight:800; color:var(--danger); }
  .mega{ font-size: 1.8rem; }            /* base loader size ~ 3x */
  .mega .santa{ font-size: 2.4rem; }     /* Santa part ~ 4x */
  .invalid{ border-color: var(--danger) !important; background:#fff5f5 !important; }
  .field-error{ display:none; font-size:12px; color:#e03131; margin-top:4px; }
  .field-error.show{ display:block; }
  .banner{ margin-top:8px; padding:8px 10px; border-radius:10px; background:#fff5f5; border:1px solid #ffd6d6; color:#9b1c1c; }
  .gate{ position:fixed; inset:0; background:rgba(248,249,251,.98); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .gate .box{ background:#fff; border:1px solid #e6ebf1; border-radius:16px; padding:20px; width:min(420px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.06); }
  .desc{ white-space:pre-wrap; color:#111; }
  .linkbtn{ background:none; border:none; color:#1877c9; text-decoration:underline; cursor:pointer; padding:0; margin-top:8px; font:inherit; }
  #globalLoading{ margin-top:12px; }
</style>
</head>
<body>
<!-- Password gate -->
<div id="gate" class="gate" style="display:none">
  <div class="box">
    <h3 style="margin:0 0 8px">Enter password</h3>
    <div class="muted" style="margin-bottom:10px">This page is for LMS volunteers.</div>
    <input id="gateInput" type="password" placeholder="Password" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:#f5f7fa" />
    <button id="gateBtn" class="btn" style="margin-top:10px; width:100%">Continue</button>
    <div id="gateMsg" class="error" style="margin-top:8px"></div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="card">
    <h1>LMS Christmas Fair â€” Volunteer sign-up</h1>
    <div class="muted">Filter by year/time â€¢ Volunteer for a slot(s) â€¢ See remaining places live</div>
  </div>

  <!-- Global loader (visible immediately; hidden only after cards render) -->
  <div id="globalLoading" class="loading mega">
    <span class="santa">ðŸŽ… Ho Ho Ho</span>-ld on while volunteer opportunities load!
  </div>

  <!-- Filters -->
  <div class="card" id="filtersCard" style="margin-top:12px; display:none">
    <div class="filters">
      <div class="left">
        <div style="font-weight:600; margin-bottom:6px">Please select your year group</div>
        <div class="chips" id="stallChips"></div>
        <button id="changeYear" class="linkbtn" style="display:none">Change year group</button>
      </div>
      <div class="right">
        <div style="font-weight:600; margin-bottom:6px">About this stall</div>
        <div id="stallDesc" class="desc">Choose a year-group stall to see details here.</div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div>
      <!-- Toolbar ABOVE role cards -->
      <div class="toolbar" id="toolbar" style="display:none">
        <div class="muted"><strong id="needFill">We need to fill 0 more slots!</strong></div>
        <div class="right">
          <label style="flex-direction:row; gap:8px; align-items:center; font-weight:600">Time
            <select id="timeSelect"></select>
          </label>
          <label style="display:flex; align-items:center; gap:8px; font-weight:600">
            <input type="checkbox" id="openAll"/> <span>Show filled slots too</span>
          </label>
        </div>
      </div>

      <div id="slots" class="slots"></div>
      <div id="slotsLoading" class="loading mega" style="display:none">
        <span class="santa">ðŸŽ… Ho Ho Ho</span>-ld on while volunteer opportunities load!
      </div>
    </div>

    <div class="panel">
      <div class="card">
        <strong>My details</strong>
        <div class="help" style="margin-top:6px; margin-bottom:6px; color:#e03131">
          Student volunteers: name and class but <em>parent/guardian email and mobile only</em>.
        </div>
        <div class="grid2" style="margin-top:4px">
          <div>
            <label class="req">First name
              <input id="firstName" autocomplete="given-name"/>
            </label>
          </div>
          <div>
            <label class="req">Last name
              <input id="lastName" autocomplete="family-name"/>
            </label>
          </div>
          <div>
            <label class="req">Email
              <input id="email" type="email" autocomplete="email"/>
              <div id="emailErr" class="field-error">Enter a valid email address.</div>
            </label>
          </div>
          <div>
            <label class="req">Mobile (for WhatsApp communications)
              <input id="mobile" type="tel" autocomplete="tel" placeholder="07xxxxxxxxx"/>
              <div id="mobileErr" class="field-error">Enter a UK mobile (07xxxxxxxxx)</div>
            </label>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="req">Class
              <select id="childClass"></select>
              <div id="classErr" class="field-error">Please choose a class.</div>
            </label>
          </div>
          <div></div>
        </div>
        <div id="formBanner" class="banner" style="display:none"></div>
      </div>

      <div class="card">
        <strong>Your selected positions</strong>
        <div id="selected"></div>
        <button id="confirm" class="btn btn-primary" style="margin-top:8px" type="button" disabled>Confirm sign-up</button>
        <div id="msg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <strong>Booked summary</strong>
        <div id="summary"></div>
      </div>
    </div>
  </div>

  <div id="debug" class="help" style="margin-top:12px"></div>
</div>

<script>
(function(){
  // === CONFIG ===
  const API_BASE = 'https://script.google.com/macros/s/AKfycbyeAsjInlE1B-z7SGXvU2fU7cO_lI7yEqFDDRKN47madhNjLFRVSP8siOiNleOO4umwCg/exec';
  const PASSWORD = 'LMSWinterWonder';

  // Time order (front-end enforced; puts Baking right after Stall Lead)
  const TIME_ORDER = [
    'Stall Lead','Baking','FRIDAY Anytime between 1pm - 6pm',
    '10.00am -12.00pm','11:00 - 12:00pm','11.00am -3:00pm',
    '12:00pm - 1:00pm','12.00am -  2.00pm','1:00pm - 2:00pm',
    '2:00pm - 3:00pm','2.00pm - 4.00pm'
  ];
  const tIdx = t => { const i=TIME_ORDER.indexOf(t||''); return i===-1?999:i; };

  // Elements (guard every lookup)
  const $ = id => document.getElementById(id);
  const gate=$('gate'), gateInput=$('gateInput'), gateBtn=$('gateBtn'), gateMsg=$('gateMsg'), app=$('app');
  const globalLoading=$('globalLoading'), filtersCard=$('filtersCard'), toolbar=$('toolbar');
  const stallChips=$('stallChips'), changeYear=$('changeYear'), stallDesc=$('stallDesc');
  const timeSelect=$('timeSelect'), openAll=$('openAll'), slotsEl=$('slots'), slotsLoading=$('slotsLoading');
  const needFill=$('needFill'), selectedEl=$('selected'), confirmBtn=$('confirm'), msgEl=$('msg');
  const firstName=$('firstName'), lastName=$('lastName'), email=$('email'), mobile=$('mobile'), childClass=$('childClass');
  const emailErr=$('emailErr'), mobileErr=$('mobileErr'), classErr=$('classErr'), formBanner=$('formBanner');
  const summaryEl=$('summary'), debugEl=$('debug');

  // State
  let meta={ stalls_meta:[], stalls:[], times:[], classes:[], descriptionsByStall:{} };
  let stallIndex=new Map(); // stall -> order
  let current={ stall:'', time:'', open:false };
  let groups=[];
  const selection=new Map();
  let descMap = new Map();

  // Helpers
  function openGate(){ if(gate && app){ gate.style.display='flex'; app.style.display='none'; } }
  function openApp(){ if(gate && app){ gate.style.display='none'; app.style.display='block'; localStorage.setItem('lms_pw_ok','1'); } }

  gateBtn && gateBtn.addEventListener('click', ()=>{ if(gateInput.value===PASSWORD) openApp(); else if(gateMsg) gateMsg.textContent='Incorrect password'; });

  function timeout(ms){ return new Promise((_,rej)=>setTimeout(()=>rej(new Error('Network timeout')),ms)); }
  async function fetchJSON(url, opts={}, tries=2){
    const cacheBust = (url.includes('?')? '&':'?') + 'cb=' + Math.random().toString(36).slice(2);
    try{
      const res = await Promise.race([fetch(url+cacheBust, {credentials:'omit', ...opts}), timeout(12000)]);
      const txt = await res.text();
      try { return JSON.parse(txt); } catch { return { ok:false, error:`HTTP ${res.status} ${res.statusText}: ${txt.slice(0,200)}` }; }
    }catch(err){
      if(tries>1) return fetchJSON(url, opts, tries-1);
      return { ok:false, error:String(err) };
    }
  }

  function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim()); }
  function isValidUKMobile(v){ const s=String(v||'').trim().replace(/\s+/g,''); return /^07\d{9}$/.test(s)||/^\+447\d{9}$/.test(s)||/^00447\d{9}$/.test(s); }
  function setValidity(input, ok, errNode){ if(!input) return; input.classList.toggle('invalid', !ok); if(errNode) errNode.classList.toggle('show', !ok); }
  function validateForm(){
    const okFirst=!!(firstName&&firstName.value.trim()), okLast=!!(lastName&&lastName.value.trim());
    setValidity(firstName, okFirst); setValidity(lastName, okLast);
    const okE=isValidEmail(email&&email.value); setValidity(email, okE, emailErr);
    const okM=isValidUKMobile(mobile&&mobile.value); setValidity(mobile, okM, mobileErr);
    const okC=!!(childClass&&childClass.value); setValidity(childClass, okC, classErr);
    return okFirst && okLast && okE && okM && okC;
  }
  document.addEventListener('input', ()=>{ if(confirmBtn) confirmBtn.disabled = !(validateForm() && selection.size>0); });

  function collapseTo(stallLabel){
    if(!stallChips) return;
    stallChips.querySelectorAll('.chip').forEach(c=>{
      const match = c.dataset.stall === stallLabel;
      c.style.display = match ? 'inline-block' : 'none';
      c.classList.toggle('active', match);
    });
    if(changeYear) changeYear.style.display = 'inline';
  }
  function expandAllChips(){
    if(!stallChips) return;
    stallChips.querySelectorAll('.chip').forEach(c=>{
      c.style.display = 'inline-block';
      c.classList.remove('active');
    });
    if(changeYear) changeYear.style.display = 'none';
  }

  function renderStallDesc(){
    if(!stallDesc) return;
    if(!current.stall){ stallDesc.textContent='Choose a year-group stall to see details here.'; return; }
    const txt = descMap.get(current.stall) || '';
    stallDesc.textContent = txt || 'No description yet.';
  }

  function sectionOf(g){
    if (g.time==='Stall Lead' || /lead/i.test(g.role||'')) return 0;       // Leads
    if (/^stall\s*co-?ordinator(?:\s*\d+)?$/i.test(g.role||'')) return 1;  // Co-ords (pre-aggregation)
    if (/bake/i.test(g.role||'') || g.time==='Baking') return 2;           // Bakers
    return 3;                                                              // Rest
  }

  function aggregateCoordinators(list){
    const isCoord = r => /^stall\s*co-?ordinator(?:\s*\d+)?$/i.test(r.role||'');
    const keep=[], byStall=new Map();
    for(const g of list){
      if(!isCoord(g)){ keep.push(g); continue; }
      const k = g.stall;
      if(!byStall.has(k)){
        byStall.set(k, {
          group_id:`coord|${k}`,
          stall:g.stall,
          year_stall:g.stall,
          role:'Stall co-ordinator',
          time:g.time,
          capacity:0, booked:0, remaining:0, available_urns:[]
        });
      }
      const agg=byStall.get(k);
      agg.capacity += g.capacity||0;
      agg.booked   += g.booked||0;
      agg.remaining+= g.remaining||0;
      if (Array.isArray(g.available_urns)) agg.available_urns.push(...g.available_urns);
    }
    return { others:keep, coords:Array.from(byStall.values()) };
  }

  function render(){
    if(!slotsEl || !needFill) return;
    const totalRemaining = groups.reduce((acc,g)=>acc+(g.remaining||0),0);
    needFill.textContent = `We need to fill ${totalRemaining} more slots!`;

    let html='', lastTime=null;
    groups.forEach(g=>{
      const sec = sectionOf(g);
      if(sec===3 && g.time!==lastTime){
        html += `<div class="timeHeader">${g.time||''}</div>`;
        lastTime = g.time;
      }
      const sel = selection.has(g.group_id);
      const btnText = sel?'Selected':'Select';
      const canSelect = (g.remaining||0)>0 || sel;
      const bookedTxt = `<span class="muted" style="margin-right:8px">${g.booked||0} booked</span>`;
      html += `<div class="slot" data-id="${g.group_id}">
        <div>
          <div><strong>${g.role||''}</strong></div>
          <div class="muted">${g.stall}${g.time && sec!==3 ? ` â€¢ ${g.time}`:''}</div>
        </div>
        <div style="display:flex; align-items:center; gap:8px; justify-content:flex-end; flex-wrap:wrap">
          ${bookedTxt}
          <div class="badge"><strong>${sel ? Math.max(0,(g.remaining||0)-1) : (g.remaining||0)}</strong> remaining</div>
          <button class="btn ${sel?'selected':''}" ${canSelect?'':'disabled'}>${btnText}</button>
        </div>
      </div>`;
    });
    slotsEl.innerHTML = html;

    // bind selects safely
    document.querySelectorAll('.slot').forEach(card=>{
      const id=card.getAttribute('data-id');
      const g=groups.find(x=>x.group_id===id);
      const btn=card.querySelector('button');
      if(!btn || !g) return;
      btn.addEventListener('click', ()=>{
        if(selection.has(id)){ selection.delete(id); }
        else if((g.remaining||0)>0){
          const urn=(g.available_urns && g.available_urns[0]) || '';
          if(urn) selection.set(id, { urn, label: `${g.year_stall}, ${g.role}, ${g.time}` });
        }
        render();
      });
    });

    const items=[...selection.values()];
    selectedEl.innerHTML = items.length
      ? `<ul>${items.map(it=>`<li>${it.label}</li>`).join('')}</ul>`
      : '<div class="muted">No positions selected yet.</div>';
    if(confirmBtn) confirmBtn.disabled = !(validateForm() && selection.size>0);
  }

  async function loadMeta(){
    const data=await fetchJSON(`${API_BASE}?action=meta`);
    if(!data.ok){ if(debugEl) debugEl.textContent='Meta error: '+(data.error||''); return; }
    meta=data;

    // stall order map (for leads/coords/bakers)
    stallIndex = new Map((meta.stalls||[]).map((s,i)=>[s,i]));

    // chips
    if(stallChips){
      stallChips.innerHTML = (meta.stalls||[]).map(s=>`<span class="chip" data-stall="${s}">${s}</span>`).join('');
      stallChips.addEventListener('click', (e)=>{
        const chip=e.target.closest('.chip'); if(!chip) return;
        const s=chip.dataset.stall;
        const wasActive = chip.classList.contains('active');
        if (wasActive){
          current.stall=''; expandAllChips(); renderStallDesc(); loadGroups();
        } else {
          current.stall=s; collapseTo(s); renderStallDesc(); loadGroups();
        }
      });
    }
    if(changeYear) changeYear.addEventListener('click', ()=>{ current.stall=''; expandAllChips(); renderStallDesc(); loadGroups(); });

    // time dropdown
    if(timeSelect){
      const times=(meta.times||[]).slice().sort((a,b)=> tIdx(a)-tIdx(b) || a.localeCompare(b));
      timeSelect.innerHTML = `<option value="">All times</option>` + times.map(t=>`<option value="${t}">${t}</option>`).join('');
      timeSelect.addEventListener('change',()=>{ current.time=timeSelect.value; loadGroups(); });
    }

    // classes
    if(childClass){
      const classes = meta.classes && meta.classes.length ? meta.classes : [];
      childClass.innerHTML = `<option value="">â€” Select class â€”</option>` + classes.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    // descriptions
    descMap = new Map(Object.entries(meta.descriptionsByStall || {}));
    renderStallDesc();

    // show filters/toolbar; keep global loader until cards render
    if(filtersCard) filtersCard.style.display='block';
    if(toolbar) toolbar.style.display='flex';
  }

  async function loadGroups(){
    if(slotsLoading) slotsLoading.style.display='block';
    if(slotsEl) slotsEl.innerHTML='';

    const params=new URLSearchParams();
    params.set('action','slots');
    if(current.stall) params.set('stall', current.stall);
    if(current.time) params.set('time', current.time);
    if(current.open) params.set('open','1');

    const data=await fetchJSON(`${API_BASE}?${params.toString()}`);
    if(!data.ok){
      if(debugEl) debugEl.textContent='Slots error: '+(data.error||'');
      groups=[];
    }else{
      let list=(data.data||[]).slice();
      // aggregate co-ordinators per stall
      const { others, coords } = aggregateCoordinators(list);
      list=[...others, ...coords];
      // sort: leads (stall order), coords (stall order), bakers (stall order), rest (time->stall->role)
      const sIdx = s => stallIndex.has(s)? stallIndex.get(s): 999;
      list.sort((a,b)=>{
        const sa=sectionOf(a), sb=sectionOf(b);
        if(sa!==sb) return sa-sb;
        if(sa<=2){
          const d=sIdx(a.stall)-sIdx(b.stall); if(d!==0) return d;
          return (a.role||'').localeCompare(b.role||'');
        }
        const dt=tIdx(a.time)-tIdx(b.time); if(dt!==0) return dt;
        const ds=sIdx(a.stall)-sIdx(b.stall); if(ds!==0) return ds;
        return (a.role||'').localeCompare(b.role||'');
      });
      groups=list;
    }

    render();

    if(slotsLoading) slotsLoading.style.display='none';
    if(globalLoading) globalLoading.style.display='none'; // hide page loader once cards are in
  }

  async function loadSummary(){
    const data=await fetchJSON(`${API_BASE}?action=summary`);
    if(!data.ok){ if(debugEl) debugEl.textContent='Summary error: '+(data.error||''); return; }
    const sum=data.data||[];
    if(summaryEl){
      summaryEl.innerHTML=sum.map(s=>{
        const pct=Math.round((s.pct||0)*100);
        return `<div style="margin:6px 0">${s.stall} â€” ${s.booked}/${s.capacity}
          <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
        </div>`;
      }).join('');
    }
  }

  confirmBtn && confirmBtn.addEventListener('click', async ()=>{
    if(formBanner){ formBanner.style.display='none'; formBanner.textContent=''; }
    const urns=[...selection.values()].map(v=>v.urn);
    if(!validateForm() || selection.size===0){
      if(formBanner){
        formBanner.textContent = selection.size===0
          ? 'Please select at least one position.'
          : 'Please correct the highlighted fields.';
        formBanner.style.display='block';
      }
      confirmBtn.disabled = true;
      return;
    }
    const original=confirmBtn.textContent;
    confirmBtn.textContent='Please waitâ€¦';
    confirmBtn.classList.add('wait');
    confirmBtn.disabled=true;
    if(msgEl) msgEl.textContent='';

    const body = new URLSearchParams({
      first_name:firstName.value.trim(),
      last_name:lastName.value.trim(),
      email:email.value.trim(),
      mobile:mobile.value.trim(),
      child_class:childClass.value,
      slot_ids: urns.join(',')
    }).toString();

    const res = await fetchJSON(API_BASE, {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body
    });
    if(!res.ok){
      const err = String(res.error||'');
      const nice = /Some positions are no longer available/i.test(err)
        ? 'Sorry, some positions are unavailable now. Select again or message your class rep to volunteer.'
        : err || 'There was an error';
      if(formBanner){ formBanner.textContent = nice; formBanner.style.display='block'; }
    }else{
      if(msgEl) msgEl.textContent='Thank you! Please make a note of your choice. Your class rep will be in touch.';
      selection.clear();
      await Promise.all([loadGroups(), loadSummary()]);
    }
    confirmBtn.textContent=original;
    confirmBtn.classList.remove('wait');
    confirmBtn.disabled = !(validateForm() && selection.size>0);
  });

  // Boot (with password gate)
  (async function(){
    try{
      if(localStorage.getItem('lms_pw_ok')!=='1'){ openGate(); return; }
      openApp();
      await loadMeta();
      await loadSummary();
      await loadGroups();
    }catch(e){
      if(debugEl) debugEl.textContent = 'Startup error: ' + e.message;
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>
