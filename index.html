<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LMS Christmas Fair — Volunteer sign-up</title>
  <style>
    :root{ --bg:#f8f9fb; --card:#fff; --text:#222; --muted:#6c757d; --accent:#3498db; --good:#2ecc71; --warn:#f1c40f; --danger:#e74c3c; --badge:#f5f7fa; }
    *{ box-sizing:border-box; }
    body{ margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1160px; margin:24px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid #e6ebf1; border-radius:16px; padding:16px; }
    h1{ font-size:28px; margin:0 0 6px; }
    .muted{ color:var(--muted); }
    .row{ display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width:1100px){ .row{ grid-template-columns: 2fr 1fr; } }
    .filters{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
    select, input, button, .chip{ font:inherit; }
    select, input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:var(--badge); }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ecf5fc; border:1px solid #d1e9ff; color:#1877c9; cursor:pointer; user-select:none; }
    .chip.active{ background:#d1e9ff; }
    .timeHeader{ margin:12px 0 6px; font-weight:700; color:#334155; }
    .slots{ display:flex; flex-direction:column; gap:12px; }
    .slot{ display:grid; grid-template-columns: 1fr 220px; gap:12px; padding:12px; border:1px solid #e6ebf1; border-radius:14px; background:var(--card); align-items:center; }
    .badge{ background:#f4faf6; border:1px solid #d6eade; border-radius:12px; padding:6px 10px; text-align:center; }
    .panel{ display:flex; flex-direction:column; gap:8px; }
    .progress{ height:14px; background:var(--badge); border:1px solid #e6ebf1; border-radius:10px; overflow:hidden; }
    .bar{ height:100%; background:var(--good); width:0%; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    ul{ margin:6px 0 0; padding-left:1rem; }
    .error{ color:var(--danger); font-weight:600; }
    .help{ font-size:12px; color:var(--muted); }
    .req::after{ content:" *"; color:var(--danger); font-weight:700; }
    .btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; }
    .btn.selected{ background:#1f7cc7; }
    /* Password gate */
    .gate{ position:fixed; inset:0; background:rgba(248,249,251,.98); display:flex; align-items:center; justify-content:center; z-index:9999; }
    .gate .box{ background:#fff; border:1px solid #e6ebf1; border-radius:16px; padding:20px; width:min(420px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.06); }
  </style>
</head>
<body>
  <div id="gate" class="gate" style="display:none">
    <div class="box">
      <h3 style="margin:0 0 8px">Enter password</h3>
      <div class="muted" style="margin-bottom:10px">This page is for LMS volunteers.</div>
      <input id="gateInput" type="password" placeholder="Password" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:#f5f7fa" />
      <button id="gateBtn" class="btn" style="margin-top:10px; width:100%">Continue</button>
      <div id="gateMsg" class="error" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="wrap" id="app" style="display:none">
    <div class="card">
      <h1>LMS Christmas Fair — Volunteer sign-up</h1>
      <div class="muted">Filter by stall/time • Pick positions • See remaining places live</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="filters" id="filters">
        <div style="flex:1 1 420px">
          <div style="font-weight:600; margin-bottom:6px">Stalls</div>
          <div class="chips" id="stallChips"></div>
          <div class="help">Tap to toggle; you can select multiple stalls.</div>
        </div>
        <label style="width:260px">Time
          <select id="timeSelect"></select>
        </label>
        <label style="flex-direction:row; align-items:center; gap:10px; font-weight:400; margin-left:auto">
          <input type="checkbox" id="openAll"/> <span>Show booked groups too</span>
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <div class="card" style="margin-bottom:8px"><strong>Available positions</strong> <span class="muted" id="foundCount"></span></div>
        <div id="slots" class="slots"></div>
      </div>
      <div class="panel">
        <div class="card">
          <strong>Your details</strong>
          <div class="grid2" style="margin-top:8px">
            <div><label class="req">First name<input id="firstName" autocomplete="given-name"/></label></div>
            <div><label class="req">Last name<input id="lastName" autocomplete="family-name"/></label></div>
            <div><label class="req">Email<input id="email" type="email" autocomplete="email"/></label></div>
            <div><label class="req">Mobile (for WhatsApp updates)<input id="mobile" type="tel" autocomplete="tel"/></label></div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div><label>Child class
              <select id="childClass"></select>
            </label></div>
            <div></div>
          </div>
          <div class="help">We’ll use your mobile number for rota updates on the day.</div>
        </div>

        <div class="card">
          <strong>Your selected positions</strong>
          <div id="selected"></div>
          <button id="confirm" class="btn" style="margin-top:8px" disabled>Confirm sign-up</button>
          <div id="msg" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="card">
          <strong>Booked summary</strong>
          <div id="summary"></div>
        </div>
      </div>
    </div>

    <div id="debug" class="help" style="margin-top:12px"></div>
  </div>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyeAsjInlE1B-z7SGXvU2fU7cO_lI7yEqFDDRKN47madhNjLFRVSP8siOiNleOO4umwCg/exec';
    const PASSWORD = 'LMSWinterWonder';

    // Password gate
    const gate = document.getElementById('gate');
    const gateInput = document.getElementById('gateInput');
    const gateBtn = document.getElementById('gateBtn');
    const gateMsg = document.getElementById('gateMsg');
    const app = document.getElementById('app');
    function openGate(){ gate.style.display='flex'; app.style.display='none'; }
    function openApp(){ gate.style.display='none'; app.style.display='block'; localStorage.setItem('lms_pw_ok','1'); }
    function checkGate(){
      if (localStorage.getItem('lms_pw_ok')==='1') { openApp(); return; }
      openGate();
    }
    gateBtn.addEventListener('click', ()=>{
      if (gateInput.value === PASSWORD) openApp();
      else gateMsg.textContent = 'Incorrect password';
    });

    const stallChips = document.getElementById('stallChips');
    const timeSelect = document.getElementById('timeSelect');
    const openAll = document.getElementById('openAll');

    const slotsEl = document.getElementById('slots');
    const foundCount = document.getElementById('foundCount');
    const selectedEl = document.getElementById('selected');
    const confirmBtn = document.getElementById('confirm');
    const msgEl = document.getElementById('msg');
    const childClass = document.getElementById('childClass');
    const debugEl = document.getElementById('debug');

    const firstName = document.getElementById('firstName');
    const lastName = document.getElementById('lastName');
    const email = document.getElementById('email');
    const mobile = document.getElementById('mobile');

    let meta = { stalls: [], times: [], classes: [] };
    let current = { stalls: new Set(), time: '', open: false };
    let groups = [];     // grouped from server
    // selection: Map group_id -> { urn, label }
    const selection = new Map();

    function qs(name) { return new URLSearchParams(location.search).get(name); }
    function showDebug(msg){ debugEl.textContent = msg || ''; if (msg) console.log('[DEBUG]', msg); }

    async function fetchJSON(url){
      const res = await fetch(url, {credentials:'omit'});
      return await res.json();
    }

    async function loadMeta(){
      const data = await fetchJSON(`${API_BASE}?action=meta`);
      if (!data.ok){ showDebug('Meta error: ' + (data.error || 'unknown')); return; }
      meta = data;

      // Stalls chips (multi-select)
      stallChips.innerHTML = (meta.stalls || []).map(s => `<span class="chip" data-stall="${s}">${s}</span>`).join('');
      stallChips.addEventListener('click', (e)=>{
        const chip = e.target.closest('.chip');
        if (!chip) return;
        const s = chip.dataset.stall;
        if (current.stalls.has(s)) { current.stalls.delete(s); chip.classList.remove('active'); }
        else { current.stalls.add(s); chip.classList.add('active'); }
        loadGroups();
      });

      // Time dropdown (server-ordered incl. “Stall Lead”)
      const times = data.times || [];
      timeSelect.innerHTML = `<option value="">All times</option>` + times.map(t => `<option value="${t}">${t}</option>`).join('');
      const tQS = qs('time'); if (tQS) { timeSelect.value = tQS; current.time = tQS; }
      timeSelect.addEventListener('change', () => { current.time = timeSelect.value; loadGroups(); });

      // Child class dropdown
      const classes = (data.classes || []).map(c => c.class).filter(Boolean).sort();
      childClass.innerHTML = `<option value="">—</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    async function loadGroups(){
      const params = new URLSearchParams();
      params.set('action','slots');
      if (current.stalls.size) params.set('stall', Array.from(current.stalls).join(','));
      if (current.time) params.set('time', current.time);
      if (current.open) params.set('open','1');

      const data = await fetchJSON(`${API_BASE}?${params.toString()}`);
      if (!data.ok){ showDebug('Slots error: ' + (data.error || 'unknown')); groups = []; render(); return; }
      groups = data.data || [];
      render();
    }

    async function loadSummary(){
      const data = await fetchJSON(`${API_BASE}?action=summary`);
      if (!data.ok){ showDebug('Summary error: ' + (data.error || 'unknown')); return; }
      const sum = data.data || [];
      const el = document.getElementById('summary');
      el.innerHTML = sum.map(s => {
        const pct = Math.round((s.pct||0)*100);
        return `<div style="margin:6px 0">${s.stall} (Y${s.year_group_owner}) — ${s.booked}/${s.capacity}
          <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
        </div>`;
      }).join('');
    }

    function render(){
      // Group groups by time to show time headers (server already ordered)
      const byTime = new Map();
      for (const g of groups) {
        if (!byTime.has(g.time)) byTime.set(g.time, []);
        byTime.get(g.time).push(g);
      }

      foundCount.textContent = groups.length ? `— ${groups.length} groups` : '';
      let html = '';
      for (const [time, gg] of byTime.entries()) {
        html += `<div class="timeHeader">${time || ''}</div>`;
        gg.forEach(g => {
          const sel = selection.has(g.group_id);
          const btnText = sel ? 'Selected' : 'Select';
          const canSelect = g.remaining > 0 || sel; // allow unselect even if now 0
          html += `<div class="slot" data-id="${g.group_id}">
            <div>
              <div><strong>${g.role || ''}</strong></div>
              <div class="muted">${g.stall}</div>
            </div>
            <div style="display:flex; align-items:center; gap:8px; justify-content:flex-end">
              <div class="badge"><strong>${sel ? g.remaining - 1 : g.remaining}</strong> remaining</div>
              <button class="btn ${sel ? 'selected':''}" ${canSelect ? '' : 'disabled'}>${btnText}</button>
            </div>
          </div>`;
        });
      }
      slotsEl.innerHTML = html;

      // Wire selects (toggle one per group)
      slotsEl.querySelectorAll('.slot').forEach(card => {
        const id = card.dataset.id;
        const g = groups.find(x => x.group_id === id);
        const btn = card.querySelector('button');
        btn.addEventListener('click', () => {
          if (selection.has(id)) {
            selection.delete(id);
          } else if (g.remaining > 0) {
            // take the first available URN
            const urn = g.available_urns[0];
            selection.set(id, { urn, label: `${g.year_stall}, ${g.role}, ${g.time}` });
          }
          render();
        });
      });

      // Selected list (pretty)
      const items = Array.from(selection.values());
      selectedEl.innerHTML = items.length
        ? `<ul>${items.map(it => `<li>${it.label}</li>`).join('')}</ul>`
        : '<div class="muted">No positions selected yet.</div>';

      updateConfirmState();
    }

    function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e||'').trim()); }
    function isValidUKMobile(m){
      const s = String(m||'').trim().replace(/\s+/g,'');
      return /^07\d{9}$/.test(s) || /^\+447\d{9}$/.test(s) || /^00447\d{9}$/.test(s);
    }

    function updateConfirmState(){
      const okForm = firstName.value && lastName.value && isValidEmail(email.value) && isValidUKMobile(mobile.value);
      const okSel = selection.size > 0;
      confirmBtn.disabled = !(okForm && okSel);
    }

    document.addEventListener('input', updateConfirmState);
    openAll.addEventListener('change', () => { current.open = openAll.checked; loadGroups(); });

    confirmBtn.addEventListener('click', async () => {
      const allUrns = Array.from(selection.values()).map(v => v.urn);
      msgEl.textContent = 'Submitting…';
      const payload = {
        first_name: firstName.value.trim(),
        last_name: lastName.value.trim(),
        email: email.value.trim(),
        mobile: mobile.value.trim(),
        child_class: childClass.value,
        slot_ids: allUrns,
      };
      try{
        const res = await fetch(API_BASE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!data.ok){ msgEl.innerHTML = `<span class="error">${data.error || 'There was an error'}</span>`; return; }
        msgEl.textContent = 'Thanks! You’re in. We’ve updated totals.';
        selection.clear();
        await Promise.all([loadGroups(), loadSummary()]);
      }catch(err){
        msgEl.innerHTML = `<span class="error">${String(err)}</span>`;
      }
    });

    // Boot after password check
    (async function(){
      checkGate();
      if (localStorage.getItem('lms_pw_ok')!=='1') return;
      try{
        const ping = await fetchJSON(`${API_BASE}?action=ping`);
        if (!ping.ok) showDebug('Ping failed.');
      }catch(e){ showDebug('Cannot reach API. Check Web App URL.'); }
      await loadMeta();
      await loadSummary();
      await loadGroups();
    })();
  </script>
</body>
</html>

