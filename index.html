<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LMS Christmas Fair — Volunteer sign-up</title>
  <style>
    :root{ --bg:#f8f9fb; --card:#fff; --text:#222; --muted:#6c757d; --accent:#3498db; --good:#2ecc71; --warn:#f1c40f; --danger:#e74c3c; --badge:#f5f7fa; }
    *{ box-sizing:border-box; }
    body{ margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1160px; margin:24px auto; padding:0 16px; }
    .card{ background:var(--card); border:1px solid #e6ebf1; border-radius:16px; padding:16px; }
    h1{ font-size:28px; margin:0 0 6px; }
    .muted{ color:var(--muted); }
    .row{ display:grid; grid-template-columns: 1fr; gap:16px; }
    @media(min-width:1100px){ .row{ grid-template-columns: 2fr 1fr; } }
    .filters{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
    select, input, button, .chip{ font:inherit; }
    select, input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:var(--badge); }
    .chips{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ecf5fc; border:1px solid #d1e9ff; color:#1877c9; cursor:pointer; user-select:none; }
    .chip.active{ background:#d1e9ff; }
    .slots{ display:flex; flex-direction:column; gap:12px; }
    .slot{ display:grid; grid-template-columns: 200px 1fr 220px; gap:12px; padding:12px; border:1px solid #e6ebf1; border-radius:14px; background:var(--card); align-items:center; }
    .time{ background:#f5f5f8; border:1px solid #e6ebf1; border-radius:12px; padding:8px; text-align:center; font-weight:600; }
    .badge{ background:#f4faf6; border:1px solid #d6eade; border-radius:12px; padding:6px 10px; text-align:center; }
    .panel{ display:flex; flex-direction:column; gap:8px; }
    .progress{ height:14px; background:var(--badge); border:1px solid #e6ebf1; border-radius:10px; overflow:hidden; }
    .bar{ height:100%; background:var(--good); width:0%; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    ul{ margin:6px 0 0; padding-left:1rem; }
    .error{ color:var(--danger); font-weight:600; }
    .help{ font-size:12px; color:var(--muted); }
    .req::after{ content:" *"; color:var(--danger); font-weight:700; }
    .qty{ display:flex; align-items:center; gap:8px; justify-content:flex-end; }
    .qty button{ border:1px solid #e6ebf1; background:#fff; border-radius:10px; padding:6px 10px; cursor:pointer; }
    .confirm{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; }
    .confirm:disabled{ opacity:.5; cursor:not-allowed; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>LMS Christmas Fair — Volunteer sign-up</h1>
      <div class="muted">Filter by stall/time • Pick positions • See remaining places live</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="filters" id="filters">
        <div style="flex:1 1 420px">
          <div style="font-weight:600; margin-bottom:6px">Stalls</div>
          <div class="chips" id="stallChips"></div>
          <div class="help">Tap to toggle; you can select multiple stalls.</div>
        </div>
        <label style="width:260px">Time
          <select id="timeSelect"></select>
        </label>
        <label style="flex-direction:row; align-items:center; gap:10px; font-weight:400; margin-left:auto">
          <input type="checkbox" id="openAll"/> <span>Show booked groups too</span>
        </label>
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <div>
        <div class="card" style="margin-bottom:8px"><strong>Available positions</strong> <span class="muted" id="foundCount"></span></div>
        <div id="slots" class="slots"></div>
      </div>
      <div class="panel">
        <div class="card">
          <strong>Your details</strong>
          <div class="grid2" style="margin-top:8px">
            <div><label class="req">First name<input id="firstName" autocomplete="given-name"/></label></div>
            <div><label class="req">Last name<input id="lastName" autocomplete="family-name"/></label></div>
            <div><label class="req">Email<input id="email" type="email" autocomplete="email"/></label></div>
            <div><label class="req">Mobile (for WhatsApp updates)<input id="mobile" type="tel" autocomplete="tel"/></label></div>
          </div>
          <div class="grid2" style="margin-top:8px">
            <div><label>Child class
              <select id="childClass"></select>
            </label></div>
            <div></div>
          </div>
          <div class="help">We’ll use your mobile number for rota updates on the day.</div>
        </div>

        <div class="card">
          <strong>Your selected positions</strong>
          <div id="selected"></div>
          <button id="confirm" class="confirm" style="margin-top:8px" disabled>Confirm sign-up</button>
          <div id="msg" class="muted" style="margin-top:6px"></div>
        </div>

        <div class="card">
          <strong>Booked summary</strong>
          <div id="summary"></div>
        </div>
      </div>
    </div>

    <div id="debug" class="help" style="margin-top:12px"></div>
  </div>

  <script>
    const API_BASE = 'https://script.google.com/macros/s/AKfycbyeAsjInlE1B-z7SGXvU2fU7cO_lI7yEqFDDRKN47madhNjLFRVSP8siOiNleOO4umwCg/exec';

    const stallChips = document.getElementById('stallChips');
    const timeSelect = document.getElementById('timeSelect');
    const openAll = document.getElementById('openAll');

    const slotsEl = document.getElementById('slots');
    const foundCount = document.getElementById('foundCount');
    const selectedEl = document.getElementById('selected');
    const confirmBtn = document.getElementById('confirm');
    const msgEl = document.getElementById('msg');
    const childClass = document.getElementById('childClass');
    const debugEl = document.getElementById('debug');

    const firstName = document.getElementById('firstName');
    const lastName = document.getElementById('lastName');
    const email = document.getElementById('email');
    const mobile = document.getElementById('mobile');

    let meta = { stalls: [], times: [], classes: [] };
    let current = { stalls: new Set(), time: '', open: false };
    let groups = [];     // server grouped slots
    // selection: map group_id -> { qty, urns[] }
    const selection = new Map();

    function qs(name) { return new URLSearchParams(location.search).get(name); }
    function showDebug(msg){ debugEl.textContent = msg || ''; if (msg) console.log('[DEBUG]', msg); }

    async function fetchJSON(url){
      const res = await fetch(url, {credentials:'omit'});
      return await res.json();
    }

    async function loadMeta(){
      const data = await fetchJSON(`${API_BASE}?action=meta`);
      if (!data.ok){ showDebug('Meta error: ' + (data.error || 'unknown')); return; }
      meta = data;

      // Stalls chips (multi-select)
      stallChips.innerHTML = (meta.stalls || meta.stalls_meta || meta.stalls || []).length
        ? [...new Set(meta.stalls)].map(s => `<span class="chip" data-stall="${s}">${s}</span>`).join('')
        : '';
      stallChips.addEventListener('click', (e)=>{
        const chip = e.target.closest('.chip');
        if (!chip) return;
        const s = chip.dataset.stall;
        if (current.stalls.has(s)) { current.stalls.delete(s); chip.classList.remove('active'); }
        else { current.stalls.add(s); chip.classList.add('active'); }
        loadGroups();
      });

      // Time dropdown (exclude N/A handled on server)
      const times = data.times || [];
      timeSelect.innerHTML = `<option value="">All times</option>` + times.map(t => `<option value="${t}">${t}</option>`).join('');
      const tQS = qs('time'); if (tQS) { timeSelect.value = tQS; current.time = tQS; }
      timeSelect.addEventListener('change', () => { current.time = timeSelect.value; loadGroups(); });

      // Child class dropdown
      const classes = (data.classes || []).map(c => c.class).filter(Boolean).sort();
      childClass.innerHTML = `<option value="">—</option>` + classes.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    async function loadGroups(){
      const params = new URLSearchParams();
      params.set('action','slots');
      if (current.stalls.size) params.set('stall', Array.from(current.stalls).join(','));
      if (current.time) params.set('time', current.time);
      if (current.open) params.set('open','1');

      const data = await fetchJSON(`${API_BASE}?${params.toString()}`);
      if (!data.ok){ showDebug('Slots error: ' + (data.error || 'unknown')); groups = []; render(); return; }
      groups = data.data || [];
      render();
    }

    async function loadSummary(){
      const data = await fetchJSON(`${API_BASE}?action=summary`);
      if (!data.ok){ showDebug('Summary error: ' + (data.error || 'unknown')); return; }
      const sum = data.data || [];
      const el = document.getElementById('summary');
      el.innerHTML = sum.map(s => {
        const pct = Math.round((s.pct||0)*100);
        return `<div style="margin:6px 0">${s.stall} (Y${s.year_group_owner}) — ${s.booked}/${s.capacity}
          <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
        </div>`;
      }).join('');
    }

    function render(){
      // Build cards
      foundCount.textContent = groups.length ? `— ${groups.length} groups` : '';
      slotsEl.innerHTML = groups.map(g => {
        const sel = selection.get(g.group_id)?.qty || 0;
        const canAdd = g.remaining - sel > 0;
        return `<div class="slot">
          <div class="time">${g.time || ''}</div>
          <div>
            <div><strong>${g.role || ''}</strong></div>
            <div class="muted">${g.stall}</div>
          </div>
          <div class="qty" data-id="${g.group_id}">
            <div class="badge"><strong>${g.remaining - sel}</strong> remaining</div>
            <button class="dec">−</button>
            <div><strong>${sel}</strong> selected</div>
            <button class="inc" ${canAdd ? '' : 'disabled'}>＋</button>
          </div>
        </div>`;
      }).join('');

      // Wire steppers
      slotsEl.querySelectorAll('.qty').forEach(q => {
        const id = q.dataset.id;
        const group = groups.find(g => g.group_id === id);
        q.querySelector('.inc').addEventListener('click', () => {
          const cur = selection.get(id) || { qty:0, urns:[] };
          if (cur.qty < group.remaining) {
            const nextUrn = group.available_urns[cur.qty]; // take next available
            cur.qty += 1;
            cur.urns.push(nextUrn);
            selection.set(id, cur);
            render();
          }
        });
        q.querySelector('.dec').addEventListener('click', () => {
          const cur = selection.get(id) || { qty:0, urns:[] };
          if (cur.qty > 0) {
            cur.qty -= 1;
            cur.urns.pop();
            if (cur.qty === 0) selection.delete(id); else selection.set(id, cur);
            render();
          }
        });
      });

      // Selected list
      const allUrns = Array.from(selection.values()).flatMap(v => v.urns);
      selectedEl.innerHTML = allUrns.length
        ? `<ul>${allUrns.map(u => `<li>${u}</li>`).join('')}</ul>`
        : '<div class="muted">No positions selected yet.</div>';

      updateConfirmState();
    }

    function updateConfirmState(){
      const total = Array.from(selection.values()).reduce((n, v) => n + v.qty, 0);
      const ok = firstName.value && lastName.value && email.value && mobile.value && total > 0;
      confirmBtn.disabled = !ok;
    }

    document.addEventListener('input', updateConfirmState);
    openAll.addEventListener('change', () => { current.open = openAll.checked; loadGroups(); });

    confirmBtn.addEventListener('click', async () => {
      const allUrns = Array.from(selection.values()).flatMap(v => v.urns);
      msgEl.textContent = 'Submitting…';
      const payload = {
        first_name: firstName.value.trim(),
        last_name: lastName.value.trim(),
        email: email.value.trim(),
        mobile: mobile.value.trim(), // REQUIRED
        child_class: childClass.value,
        slot_ids: allUrns,
      };
      try{
        const res = await fetch(API_BASE, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (!data.ok){ msgEl.innerHTML = `<span class="error">${data.error || 'There was an error'}</span>`; return; }
        msgEl.textContent = 'Thanks! You’re in. We’ve updated totals.';
        selection.clear();
        await Promise.all([loadGroups(), loadSummary()]);
      }catch(err){
        msgEl.innerHTML = `<span class="error">${String(err)}</span>`;
      }
    });

    // Boot
    (async function(){
      try{
        const ping = await fetchJSON(`${API_BASE}?action=ping`);
        if (!ping.ok) showDebug('Ping failed.');
      }catch(e){ showDebug('Cannot reach API. Check Web App URL.'); }
      await loadMeta();
      await loadSummary();
      await loadGroups();
    })();
  </script>
</body>
</html>
