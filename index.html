<!doctype html>
<html lang="en"><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LMS Christmas Fair â€” Volunteer sign-up</title>
<style>
  :root{ --bg:#f8f9fb; --card:#fff; --text:#222; --muted:#6c757d; --accent:#3498db; --accent-wait:#7f8c8d; --good:#2ecc71; --danger:#e74c3c; --badge:#f5f7fa; }
  *{ box-sizing:border-box; }
  body{ margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width:1160px; margin:24px auto; padding:0 16px; }
  .card{ background:var(--card); border:1px solid #e6ebf1; border-radius:16px; padding:16px; }
  h1{ font-size:28px; margin:0 0 6px; }
  .muted{ color:var(--muted); }
  .row{ display:grid; grid-template-columns: 1fr; gap:16px; }
  @media(min-width:1100px){ .row{ grid-template-columns: 2fr 1fr; } }
  .filters{ display:flex; gap:16px; align-items:flex-start; }
  .filters .left{ flex: 1 1 auto; min-width:260px; }
  .filters .right{ flex: 1 1 40%; min-width:260px; }
  label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
  select, input, button, .chip{ font:inherit; }
  select, input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:var(--badge); transition: border-color .15s, background .15s; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ecf5fc; border:1px solid #d1e9ff; color:#1877c9; cursor:pointer; user-select:none; }
  .chip.active{ background:#d1e9ff; }
  .timeHeader{ margin:12px 0 6px; font-weight:700; color:#334155; }
  .slots{ display:flex; flex-direction:column; gap:12px; min-height:60px; }
  .toolbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .toolbar .right{ display:flex; gap:12px; align-items:center; }
  .slot{ display:grid; grid-template-columns: 1fr 220px; gap:12px; padding:12px; border:1px solid #e6ebf1; border-radius:14px; background:var(--card); align-items:center; }
  .badge{ background:#f4faf6; border:1px solid #d6eade; border-radius:12px; padding:6px 10px; text-align:center; }
  .panel{ display:flex; flex-direction:column; gap:8px; }
  .progress{ height:14px; background:var(--badge); border:1px solid #e6ebf1; border-radius:10px; overflow:hidden; }
  .bar{ height:100%; background:var(--good); width:0%; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  ul{ margin:6px 0 0; padding-left:1rem; }
  .error{ color:var(--danger); font-weight:600; }
  .help{ font-size:12px; color:var(--muted); }
  .req::after{ content:" *"; color:var(--danger); font-weight:700; }
  .btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; transition:background .2s, opacity .2s; }
  .btn.selected{ background:#1f7cc7; }
  .btn.wait{ background:var(--accent-wait); opacity:.85; }
  .loading{ padding:16px; color:#334155; font-weight:600; }
  .invalid{ border-color: var(--danger) !important; background:#fff5f5 !important; }
  .field-error{ display:none; font-size:12px; color:var(--danger); margin-top:4px; }
  .field-error.show{ display:block; }
  .banner{ margin-top:8px; padding:8px 10px; border-radius:10px; background:#fff5f5; border:1px solid #ffd6d6; color:#9b1c1c; }
  .gate{ position:fixed; inset:0; background:rgba(248,249,251,.98); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .gate .box{ background:#fff; border:1px solid #e6ebf1; border-radius:16px; padding:20px; width:min(420px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.06); }
  .desc{ white-space:pre-wrap; }
</style>
</head>
<body>
<div id="gate" class="gate" style="display:none">
  <div class="box">
    <h3 style="margin:0 0 8px">Enter password</h3>
    <div class="muted" style="margin-bottom:10px">This page is for LMS volunteers.</div>
    <input id="gateInput" type="password" placeholder="Password" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:#f5f7fa" />
    <button id="gateBtn" class="btn" style="margin-top:10px; width:100%">Continue</button>
    <div id="gateMsg" class="error" style="margin-top:8px"></div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="card">
    <h1>LMS Christmas Fair â€” Volunteer sign-up</h1>
    <div class="muted">Filter by year/time â€¢ Pick positions â€¢ See remaining places live</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="filters">
      <div class="left">
        <div style="font-weight:600; margin-bottom:6px">Please select your year group</div>
        <div class="chips" id="stallChips"></div>
      </div>
      <div class="right">
        <div style="font-weight:600; margin-bottom:6px">About this stall</div>
        <div id="stallDesc" class="desc muted">Choose a year-group stall to see details here.</div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div>
      <div class="toolbar">
        <div class="muted"><strong>Available positions</strong> <span id="foundCount"></span></div>
        <div class="right">
          <label style="flex-direction:row; gap:8px; align-items:center; font-weight:600">Time
            <select id="timeSelect"></select>
          </label>
          <label style="display:flex; align-items:center; gap:8px; font-weight:600">
            <input type="checkbox" id="openAll"/> <span>Show booked roles too</span>
          </label>
        </div>
      </div>

      <div id="slots" class="slots"></div>
      <div id="slotsLoading" class="loading" style="display:none">ðŸŽ… Ho Ho Ho... Loading helper opportunities</div>
    </div>

    <div class="panel">
      <div class="card">
        <strong>My details</strong>
        <div class="help" style="margin-top:6px; margin-bottom:6px">
          Student volunteers: name and class but <em>parent/guardian email and mobile only</em>.
        </div>
        <div class="grid2" style="margin-top:4px">
          <div>
            <label class="req">First name
              <input id="firstName" autocomplete="given-name"/>
            </label>
          </div>
          <div>
            <label class="req">Last name
              <input id="lastName" autocomplete="family-name"/>
            </label>
          </div>
          <div>
            <label class="req">Email
              <input id="email" type="email" autocomplete="email"/>
              <div id="emailErr" class="field-error">Enter a valid email address.</div>
            </label>
          </div>
          <div>
            <label class="req">Mobile (for WhatsApp communications)
              <input id="mobile" type="tel" autocomplete="tel" placeholder="07xxxxxxxxx"/>
              <div id="mobileErr" class="field-error">Enter a UK mobile (07xxxxxxxxx)</div>
            </label>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="req">Class
              <select id="childClass"></select>
              <div id="classErr" class="field-error">Please choose a class.</div>
            </label>
          </div>
          <div></div>
        </div>
        <div id="formBanner" class="banner" style="display:none"></div>
      </div>

      <div class="card">
        <strong>Your selected positions</strong>
        <div id="selected"></div>
        <button id="confirm" class="btn" style="margin-top:8px" type="button" disabled>Confirm sign-up</button>
        <div id="msg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <strong>Booked summary</strong>
        <div id="summary"></div>
      </div>
    </div>
  </div>

  <div id="debug" class="help" style="margin-top:12px"></div>
</div>

<script>
  const API_BASE = 'https://script.google.com/macros/s/AKfycbyeAsjInlE1B-z7SGXvU2fU7cO_lI7yEqFDDRKN47madhNjLFRVSP8siOiNleOO4umwCg/exec';
  const PASSWORD = 'LMSWinterWonder';

  const SUMMARY_ORDER = [
    "Y7: Santa's Grotto (Y7)",
    "Y8 Mulled wine, Mince Pies & Hot Drinks (Y8)",
    "Y9: Bakery and Spin the Wheel (Y9)",
    "Y10: Books & Pre Loved Stall Rota (Y10)",
    "Y11: Teen Tombola (Y11)",
    "Y12/13 Vintage, Uniform & Bottle Tombola Rota (Y12)"
  ];

  const CLASS_ORDER = [
    "7KM","7KL","7BU","7AB",
    "8RE","8PH","8NAA","8KH",
    "9VM","9NA","9AW","9ATB",
    "10OM","10KF","10JT","10GR","10AN",
    "11KAH","11IDC","11EW","11DU","11CJ",
    "12/13SSS","12/13RC","12/13NB","12/13LVE","12/13LN","12/13JD","12/13ID","12/13EDW","12/13AR","12/13ALB"
  ];

  // Password gate
  const gate=document.getElementById('gate'), gateInput=document.getElementById('gateInput'),
        gateBtn=document.getElementById('gateBtn'), gateMsg=document.getElementById('gateMsg'),
        app=document.getElementById('app');
  function openGate(){ gate.style.display='flex'; app.style.display='none'; }
  function openApp(){ gate.style.display='none'; app.style.display='block'; localStorage.setItem('lms_pw_ok','1'); }
  gateBtn.addEventListener('click', ()=>{ if(gateInput.value===PASSWORD) openApp(); else gateMsg.textContent='Incorrect password'; });

  // Elements
  const stallChips=document.getElementById('stallChips');
  const timeSelect=document.getElementById('timeSelect');
  const openAll=document.getElementById('openAll');

  const stallDesc=document.getElementById('stallDesc');

  const slotsEl=document.getElementById('slots');
  const slotsLoading=document.getElementById('slotsLoading');
  const foundCount=document.getElementById('foundCount');
  const selectedEl=document.getElementById('selected');
  const confirmBtn=document.getElementById('confirm');
  const msgEl=document.getElementById('msg');
  const childClass=document.getElementById('childClass');
  const classErr=document.getElementById('classErr');
  const debugEl=document.getElementById('debug');

  const firstName=document.getElementById('firstName');
  const lastName=document.getElementById('lastName');
  const email=document.getElementById('email');
  const mobile=document.getElementById('mobile');
  const emailErr=document.getElementById('emailErr');
  const mobileErr=document.getElementById('mobileErr');
  const formBanner=document.getElementById('formBanner');

  let meta={ stalls_meta:[], stalls:[], times:[], classes:[] };
  let current={ stall:'', time:'', open:false }; // single-select stall
  let groups=[]; // grouped from server
  const selection=new Map(); // selections

  function showDebug(msg){ if(debugEl) debugEl.textContent = msg||''; if(msg) console.log('[DEBUG]', msg); }
  async function fetchJSON(url){
    const res=await fetch(url,{credentials:'omit'});
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch (e) { return { ok:false, error:`HTTP ${res.status} ${res.statusText}: ${txt.slice(0,200)}` }; }
  }

  // Validation
  function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim()); }
  function isValidUKMobile(v){ const s=String(v||'').trim().replace(/\s+/g,''); return /^07\d{9}$/.test(s)||/^\+447\d{9}$/.test(s)||/^00447\d{9}$/.test(s); }
  function setValidity(input, ok, errNode){ input.classList.toggle('invalid', !ok); if(errNode) errNode.classList.toggle('show', !ok); }
  function validateEmailField(){ const ok=isValidEmail(email.value); setValidity(email, ok, emailErr); return ok; }
  function validateMobileField(){ const ok=isValidUKMobile(mobile.value); setValidity(mobile, ok, mobileErr); return ok; }
  function validateClassField(){ const ok=!!childClass.value; setValidity(childClass, ok, classErr); return ok; }
  function validateForm(){
    const okFirst=!!firstName.value.trim(); const okLast=!!lastName.value.trim();
    setValidity(firstName, okFirst); setValidity(lastName, okLast);
    return okFirst && okLast && validateEmailField() && validateMobileField() && validateClassField();
  }
  email.addEventListener('blur', validateEmailField);
  mobile.addEventListener('blur', validateMobileField);
  childClass.addEventListener('blur', validateClassField);
  firstName.addEventListener('blur', ()=>setValidity(firstName, !!firstName.value.trim()));
  lastName.addEventListener('blur', ()=>setValidity(lastName, !!lastName.value.trim()));
  document.addEventListener('input', updateConfirmState);
  function updateConfirmState(){ confirmBtn.disabled = !(validateForm() && selection.size>0); }

  // ---- Description mapping (first column now year keys: 6,7,8,... or 12-13) ----
  function toYearKey(val){
    if(val==null) return '';
    let s=String(val).trim();
    // Accept numeric cells (e.g. 7), strings "7", "12-13", "12/13"
    if(/^\d{1,2}$/.test(s)) return s;
    if(/^\d{1,2}\s*[-/]\s*\d{1,2}$/.test(s)) return s.replace(/\s+/g,'').replace('/','-');
    // Fallback: first two numbers possibly paired
    const m = s.match(/(\d{1,2})(?:\s*[-/]\s*(\d{1,2}))?/);
    return m ? (m[2] ? `${m[1]}-${m[2]}` : m[1]) : '';
  }
  function extractYearFromStallName(stall){
    if(!stall) return '';
    // e.g. "Y9: Bakery..." -> 9 ; "Y12/13 Vintage ..." -> 12-13
    const m = stall.match(/Y\s*(\d{1,2})(?:\s*[/\-]\s*(\d{1,2}))?/i);
    return m ? (m[2] ? `${m[1]}-${m[2]}` : m[1]) : '';
  }
  function buildYearDescriptionIndex(rows){
    const map=new Map();
    for(const r of (rows||[])){
      const key = toYearKey(r['Year-Stall']||r.year_stall||r.year_group_owner||r.year||r.key);
      const desc = r.Description || r.description || '';
      if(key && desc) map.set(key, desc);
    }
    return map;
  }
  let yearDesc = new Map();

  function renderStallDesc(){
    if(!current.stall){ stallDesc.textContent='Choose a year-group stall to see details here.'; return; }
    const stallYear = toYearKey(
      extractYearFromStallName(current.stall) ||
      (meta.stalls_meta||[]).find(x=>x.stall===current.stall)?.year_group_owner
    );
    let txt = '';
    if(stallYear){
      // Exact match first
      txt = yearDesc.get(stallYear) || '';
      // If "12" but we have "12-13", match that too
      if(!txt && (stallYear==='12' || stallYear==='13')) txt = yearDesc.get('12-13') || '';
    }
    stallDesc.textContent = txt || 'No description yet.';
  }

  async function loadMeta(){
    const data=await fetchJSON(`${API_BASE}?action=meta`);
    if(!data.ok){ showDebug('Meta error: ' + (data.error||'unknown')); return; }
    meta=data;

    // Build yearâ†’description map from the Descriptions sheet rows included in stalls_meta
    yearDesc = buildYearDescriptionIndex(meta.stalls_meta);

    // Single-select chips
    stallChips.innerHTML = (meta.stalls||[]).map(s=>`<span class="chip" data-stall="${s}">${s}</span>`).join('');
    stallChips.addEventListener('click',(e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      const s=chip.dataset.stall;
      const wasActive = chip.classList.contains('active');
      stallChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      if (wasActive) current.stall='';
      else { chip.classList.add('active'); current.stall=s; }
      renderStallDesc();
      loadGroups();
    });

    // Time dropdown
    const times=data.times||[];
    timeSelect.innerHTML = `<option value="">All times</option>` + times.map(t=>`<option value="${t}">${t}</option>`).join('');
    timeSelect.addEventListener('change',()=>{ current.time=timeSelect.value; loadGroups(); });

    // Class dropdown â€” mandatory
    childClass.innerHTML = `<option value="">â€” Select class â€”</option>` + CLASS_ORDER.map(c=>`<option value="${c}">${c}</option>`).join('');

    renderStallDesc();
  }

  async function loadGroups(){
    // show loader (and clear cards so user sees it)
    slotsLoading.style.display='block';
    slotsEl.innerHTML='';

    const params=new URLSearchParams();
    params.set('action','slots');
    if(current.stall) params.set('stall', current.stall);
    if(current.time) params.set('time', current.time);
    if(current.open) params.set('open','1');

    const data=await fetchJSON(`${API_BASE}?${params.toString()}`);
    if(!data.ok){ showDebug('Slots error: ' + (data.error||'unknown')); groups=[]; render(); slotsLoading.style.display='none'; return; }
    groups=data.data||[];
    render();
    slotsLoading.style.display='none';
  }

  async function loadSummary(){
    const data=await fetchJSON(`${API_BASE}?action=summary`);
    if(!data.ok){ showDebug('Summary error: ' + (data.error||'unknown')); return; }
    const sum=data.data||[];
    const items=sum.map(s=>({ label:`${s.stall} (Y${s.year_group_owner})`, booked:s.booked, capacity:s.capacity, pct:s.pct }));
    const orderMap=new Map(SUMMARY_ORDER.map((lab,i)=>[lab,i]));
    items.sort((a,b)=>{
      const ia=orderMap.has(a.label)?orderMap.get(a.label):999 + a.label.localeCompare(b.label);
      const ib=orderMap.has(b.label)?orderMap.get(b.label):999 + b.label.localeCompare(a.label);
      return ia-ib;
    });
    document.getElementById('summary').innerHTML=items.map(s=>{
      const pct=Math.round((s.pct||0)*100);
      return `<div style="margin:6px 0">${s.label} â€” ${s.booked}/${s.capacity}
        <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
      </div>`;
    }).join('');
  }

  function render(){
    foundCount.textContent = groups.length ? `â€” ${groups.length} roles` : '';

    const byTime=new Map();
    for(const g of groups){ if(!byTime.has(g.time)) byTime.set(g.time, []); byTime.get(g.time).push(g); }

    let html='';
    for(const [time, gg] of byTime.entries()){
      html += `<div class="timeHeader">${time||''}</div>`;
      gg.forEach(g=>{
        const sel=selection.has(g.group_id);
        const btnText=sel?'Selected':'Select';
        const canSelect = g.remaining>0 || sel;
        html += `<div class="slot" data-id="${g.group_id}">
          <div>
            <div><strong>${g.role||''}</strong></div>
            <div class="muted">${g.stall}</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px; justify-content:flex-end">
            <div class="badge"><strong>${sel ? g.remaining-1 : g.remaining}</strong> remaining</div>
            <button class="btn ${sel?'selected':''}" ${canSelect?'':'disabled'}>${btnText}</button>
          </div>
        </div>`;
      });
    }
    slotsEl.innerHTML = html;

    document.querySelectorAll('.slot').forEach(card=>{
      const id=card.dataset.id;
      const g=groups.find(x=>x.group_id===id);
      const btn=card.querySelector('button');
      if(!btn || !g) return;
      btn.addEventListener('click', ()=>{
        if(selection.has(id)){ selection.delete(id); }
        else if(g.remaining>0){
          const urn=g.available_urns[0];
          selection.set(id, { urn, label: `${g.year_stall}, ${g.role}, ${g.time}` });
        }
        render();
      });
    });

    const items=[...selection.values()];
    selectedEl.innerHTML = items.length
      ? `<ul>${items.map(it=>`<li>${it.label}</li>`).join('')}</ul>`
      : '<div class="muted">No positions selected yet.</div>';

    updateConfirmState();
  }

  openAll.addEventListener('change', (e)=>{ current.open=e.target.checked; loadGroups(); });

  confirmBtn.addEventListener('click', async ()=>{
    formBanner.style.display='none'; formBanner.textContent='';
    const urns=[...selection.values()].map(v=>v.urn);

    const ok = (()=>{
      const okFirst=!!firstName.value.trim(), okLast=!!lastName.value.trim();
      const okE=isValidEmail(email.value), okM=isValidUKMobile(mobile.value), okC=!!childClass.value;
      firstName.classList.toggle('invalid', !okFirst);
      lastName.classList.toggle('invalid', !okLast);
      email.classList.toggle('invalid', !okE); emailErr.classList.toggle('show', !okE);
      mobile.classList.toggle('invalid', !okM); mobileErr.classList.toggle('show', !okM);
      childClass.classList.toggle('invalid', !okC); classErr.classList.toggle('show', !okC);
      return okFirst && okLast && okE && okM && okC;
    })();
    if(!ok || selection.size===0){
      formBanner.textContent = selection.size===0
        ? 'Please select at least one position.'
        : 'Please correct the highlighted fields.';
      formBanner.style.display='block';
      (document.querySelector('.invalid')||firstName).focus({preventScroll:false});
      updateConfirmState();
      return;
    }

    const original=confirmBtn.textContent;
    confirmBtn.textContent='Please waitâ€¦';
    confirmBtn.classList.add('wait');
    confirmBtn.disabled=true;
    msgEl.textContent='';

    const form = new URLSearchParams({
      first_name:firstName.value.trim(),
      last_name:lastName.value.trim(),
      email:email.value.trim(),
      mobile:mobile.value.trim(),
      child_class:childClass.value,
      slot_ids: urns.join(',')
    });

    try{
      const res = await fetch(API_BASE, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: form.toString(),
        redirect: 'follow'
      });
      const raw = await res.text();
      let data; try { data = JSON.parse(raw); } catch { data = { ok:false, error:`HTTP ${res.status} ${res.statusText}: ${raw.slice(0,200)}` }; }
      if(!data.ok){
        const err = String(data.error||'');
        const nice = /Some positions are no longer available/i.test(err)
          ? 'Sorry, some positions are unavailable now. Select again or message your class rep to volunteer.'
          : err || 'There was an error';
        formBanner.textContent = nice; formBanner.style.display='block';
      }else{
        msgEl.textContent='Thank you! Please make a note of your choice. Your class rep will be in touch.';
        selection.clear();
        await Promise.all([loadGroups(), loadSummary()]);
      }
    }catch(err){
      formBanner.textContent = String(err); formBanner.style.display='block';
    }finally{
      confirmBtn.textContent=original;
      confirmBtn.classList.remove('wait');
      updateConfirmState();
    }
  });

  (async function(){
    if(localStorage.getItem('lms_pw_ok')!=='1'){ openGate(); return; }
    openApp();
    await loadMeta();
    await loadSummary();
    await loadGroups();
  })();
</script>
</body>
</html>

<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LMS Christmas Fair â€” Volunteer sign-up</title>
<style>
  :root{ --bg:#f8f9fb; --card:#fff; --text:#222; --muted:#6c757d; --accent:#3498db; --accent-wait:#7f8c8d; --good:#2ecc71; --danger:#e74c3c; --badge:#f5f7fa; }
  *{ box-sizing:border-box; }
  body{ margin:0; font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); color:var(--text); }
  .wrap{ max-width:1160px; margin:24px auto; padding:0 16px; }
  .card{ background:var(--card); border:1px solid #e6ebf1; border-radius:16px; padding:16px; }
  h1{ font-size:28px; margin:0 0 6px; }
  .muted{ color:var(--muted); }
  .row{ display:grid; grid-template-columns: 1fr; gap:16px; }
  @media(min-width:1100px){ .row{ grid-template-columns: 2fr 1fr; } }
  .filters{ display:flex; gap:16px; align-items:flex-start; }
  .filters .left{ flex: 1 1 auto; min-width:260px; }
  .filters .right{ flex: 1 1 40%; min-width:260px; }
  label{ display:flex; flex-direction:column; gap:6px; font-weight:600; }
  select, input, button, .chip{ font:inherit; }
  select, input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:var(--badge); transition: border-color .15s, background .15s; }
  .chips{ display:flex; gap:8px; flex-wrap:wrap; }
  .chip{ display:inline-block; padding:6px 12px; border-radius:999px; background:#ecf5fc; border:1px solid #d1e9ff; color:#1877c9; cursor:pointer; user-select:none; }
  .chip.active{ background:#d1e9ff; }
  .timeHeader{ margin:12px 0 6px; font-weight:700; color:#334155; }
  .slots{ display:flex; flex-direction:column; gap:12px; }
  .toolbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:8px; }
  .toolbar .right{ display:flex; gap:12px; align-items:center; }
  .slot{ display:grid; grid-template-columns: 1fr 220px; gap:12px; padding:12px; border:1px solid #e6ebf1; border-radius:14px; background:var(--card); align-items:center; }
  .badge{ background:#f4faf6; border:1px solid #d6eade; border-radius:12px; padding:6px 10px; text-align:center; }
  .panel{ display:flex; flex-direction:column; gap:8px; }
  .progress{ height:14px; background:var(--badge); border:1px solid #e6ebf1; border-radius:10px; overflow:hidden; }
  .bar{ height:100%; background:var(--good); width:0%; }
  .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  ul{ margin:6px 0 0; padding-left:1rem; }
  .error{ color:var(--danger); font-weight:600; }
  .help{ font-size:12px; color:var(--muted); }
  .req::after{ content:" *"; color:var(--danger); font-weight:700; }
  .btn{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:10px 14px; cursor:pointer; transition:background .2s, opacity .2s; }
  .btn.selected{ background:#1f7cc7; }
  .btn.wait{ background:var(--accent-wait); opacity:.85; }
  .loading{ padding:16px; color:#334155; font-weight:600; }
  .invalid{ border-color: var(--danger) !important; background:#fff5f5 !important; }
  .field-error{ display:none; font-size:12px; color:var(--danger); margin-top:4px; }
  .field-error.show{ display:block; }
  .banner{ margin-top:8px; padding:8px 10px; border-radius:10px; background:#fff5f5; border:1px solid #ffd6d6; color:#9b1c1c; }
  .gate{ position:fixed; inset:0; background:rgba(248,249,251,.98); display:flex; align-items:center; justify-content:center; z-index:9999; }
  .gate .box{ background:#fff; border:1px solid #e6ebf1; border-radius:16px; padding:20px; width:min(420px,90vw); box-shadow:0 10px 30px rgba(0,0,0,.06); }
  .desc{ white-space:pre-wrap; }
</style>
</head>
<body>
<div id="gate" class="gate" style="display:none">
  <div class="box">
    <h3 style="margin:0 0 8px">Enter password</h3>
    <div class="muted" style="margin-bottom:10px">This page is for LMS volunteers.</div>
    <input id="gateInput" type="password" placeholder="Password" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6ebf1; background:#f5f7fa" />
    <button id="gateBtn" class="btn" style="margin-top:10px; width:100%">Continue</button>
    <div id="gateMsg" class="error" style="margin-top:8px"></div>
  </div>
</div>

<div class="wrap" id="app" style="display:none">
  <div class="card">
    <h1>LMS Christmas Fair â€” Volunteer sign-up</h1>
    <div class="muted">Filter by year/time â€¢ Pick positions â€¢ See remaining places live</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="filters">
      <div class="left">
        <div style="font-weight:600; margin-bottom:6px">Please select your year group</div>
        <div class="chips" id="stallChips"></div>
      </div>
      <div class="right">
        <div style="font-weight:600; margin-bottom:6px">About this stall</div>
        <div id="stallDesc" class="desc muted">Choose a year-group stall to see details here.</div>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:12px">
    <div>
      <div class="toolbar">
        <div class="muted"><strong>Available positions</strong> <span id="foundCount"></span></div>
        <div class="right">
          <label style="flex-direction:row; gap:8px; align-items:center; font-weight:600">Time
            <select id="timeSelect"></select>
          </label>
          <label style="display:flex; align-items:center; gap:8px; font-weight:600">
            <input type="checkbox" id="openAll"/> <span>Show booked roles too</span>
          </label>
        </div>
      </div>

      <div id="slots" class="slots">
        <div id="loading" class="loading">ðŸŽ… Ho Ho Ho... Loading helper opportunities</div>
      </div>
    </div>

    <div class="panel">
      <div class="card">
        <strong>My details</strong>
        <div class="help" style="margin-top:6px; margin-bottom:6px">
          Student volunteers: name and class but <em>parent/guardian email and mobile only</em>.
        </div>
        <div class="grid2" style="margin-top:4px">
          <div>
            <label class="req">First name
              <input id="firstName" autocomplete="given-name"/>
            </label>
          </div>
          <div>
            <label class="req">Last name
              <input id="lastName" autocomplete="family-name"/>
            </label>
          </div>
          <div>
            <label class="req">Email
              <input id="email" type="email" autocomplete="email"/>
              <div id="emailErr" class="field-error">Enter a valid email address.</div>
            </label>
          </div>
          <div>
            <label class="req">Mobile (for WhatsApp communications)
              <input id="mobile" type="tel" autocomplete="tel" placeholder="07xxxxxxxxx"/>
              <div id="mobileErr" class="field-error">Enter a UK mobile (07xxxxxxxxx)</div>
            </label>
          </div>
        </div>
        <div class="grid2" style="margin-top:8px">
          <div>
            <label class="req">Class
              <select id="childClass"></select>
              <div id="classErr" class="field-error">Please choose a class.</div>
            </label>
          </div>
          <div></div>
        </div>
        <div id="formBanner" class="banner" style="display:none"></div>
      </div>

      <div class="card">
        <strong>Your selected positions</strong>
        <div id="selected"></div>
        <button id="confirm" class="btn" style="margin-top:8px" type="button" disabled>Confirm sign-up</button>
        <div id="msg" class="muted" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <strong>Booked summary</strong>
        <div id="summary"></div>
      </div>
    </div>
  </div>

  <div id="debug" class="help" style="margin-top:12px"></div>
</div>

<script>
  const API_BASE = 'https://script.google.com/macros/s/AKfycbyeAsjInlE1B-z7SGXvU2fU7cO_lI7yEqFDDRKN47madhNjLFRVSP8siOiNleOO4umwCg/exec';
  const PASSWORD = 'LMSWinterWonder';

  const SUMMARY_ORDER = [
    "Y7: Santa's Grotto (Y7)",
    "Y8 Mulled wine, Mince Pies & Hot Drinks (Y8)",
    "Y9: Bakery and Spin the Wheel (Y9)",
    "Y10: Books & Pre Loved Stall Rota (Y10)",
    "Y11: Teen Tombola (Y11)",
    "Y12/13 Vintage, Uniform & Bottle Tombola Rota (Y12)"
  ];

  const CLASS_ORDER = [
    "7KM","7KL","7BU","7AB",
    "8RE","8PH","8NAA","8KH",
    "9VM","9NA","9AW","9ATB",
    "10OM","10KF","10JT","10GR","10AN",
    "11KAH","11IDC","11EW","11DU","11CJ",
    "12/13SSS","12/13RC","12/13NB","12/13LVE","12/13LN","12/13JD","12/13ID","12/13EDW","12/13AR","12/13ALB"
  ];

  // Password gate
  const gate=document.getElementById('gate'), gateInput=document.getElementById('gateInput'),
        gateBtn=document.getElementById('gateBtn'), gateMsg=document.getElementById('gateMsg'),
        app=document.getElementById('app');
  function openGate(){ gate.style.display='flex'; app.style.display='none'; }
  function openApp(){ gate.style.display='none'; app.style.display='block'; localStorage.setItem('lms_pw_ok','1'); }
  function checkGate(){ if(localStorage.getItem('lms_pw_ok')==='1') openApp(); else openGate(); }
  gateBtn.addEventListener('click', ()=>{ if(gateInput.value===PASSWORD) openApp(); else gateMsg.textContent='Incorrect password'; });

  // Elements
  const stallChips=document.getElementById('stallChips');
  const timeSelect=document.getElementById('timeSelect');
  const openAll=document.getElementById('openAll');

  const stallDesc=document.getElementById('stallDesc');

  const slotsEl=document.getElementById('slots');
  const foundCount=document.getElementById('foundCount');
  const selectedEl=document.getElementById('selected');
  const confirmBtn=document.getElementById('confirm');
  const msgEl=document.getElementById('msg');
  const childClass=document.getElementById('childClass');
  const classErr=document.getElementById('classErr');
  const debugEl=document.getElementById('debug');

  const firstName=document.getElementById('firstName');
  const lastName=document.getElementById('lastName');
  const email=document.getElementById('email');
  const mobile=document.getElementById('mobile');
  const emailErr=document.getElementById('emailErr');
  const mobileErr=document.getElementById('mobileErr');
  const formBanner=document.getElementById('formBanner');

  let meta={ stalls_meta:[], stalls:[], times:[], classes:[] };
  let current={ stall:'', time:'', open:false }; // single-select stall
  let groups=[]; // grouped from server
  const selection=new Map(); // <â€” single declaration (fixed)

  function showDebug(msg){ if(debugEl) debugEl.textContent = msg||''; if(msg) console.log('[DEBUG]', msg); }
  async function fetchJSON(url){
    const res=await fetch(url,{credentials:'omit'});
    const txt = await res.text();
    try { return JSON.parse(txt); }
    catch (e) { return { ok:false, error:`HTTP ${res.status} ${res.statusText}: ${txt.slice(0,200)}` }; }
  }

  // Validation helpers
  function isValidEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim()); }
  function isValidUKMobile(v){
    const s=String(v||'').trim().replace(/\s+/g,'');
    return /^07\d{9}$/.test(s)||/^\+447\d{9}$/.test(s)||/^00447\d{9}$/.test(s);
  }
  function setValidity(input, ok, errNode){
    if(!input) return;
    input.classList.toggle('invalid', !ok);
    if(errNode) errNode.classList.toggle('show', !ok);
  }
  function validateEmailField(){ const ok=isValidEmail(email.value); setValidity(email, ok, emailErr); return ok; }
  function validateMobileField(){ const ok=isValidUKMobile(mobile.value); setValidity(mobile, ok, mobileErr); return ok; }
  function validateClassField(){ const ok=!!childClass.value; setValidity(childClass, ok, classErr); return ok; }
  function validateForm(){
    const okFirst = !!firstName.value.trim();
    const okLast = !!lastName.value.trim();
    setValidity(firstName, okFirst);
    setValidity(lastName, okLast);
    const okE = validateEmailField();
    const okM = validateMobileField();
    const okC = validateClassField();
    return okFirst && okLast && okE && okM && okC;
  }
  email.addEventListener('blur', validateEmailField);
  mobile.addEventListener('blur', validateMobileField);
  childClass.addEventListener('blur', validateClassField);
  firstName.addEventListener('blur', ()=>setValidity(firstName, !!firstName.value.trim()));
  lastName.addEventListener('blur', ()=>setValidity(lastName, !!lastName.value.trim()));
  document.addEventListener('input', updateConfirmState);

  function updateConfirmState(){
    const okForm = validateForm();
    const okSel = selection.size>0;
    confirmBtn.disabled = !(okForm && okSel);
  }

  // Description index by stall and by year key (e.g., "7", "8", "12-13")
  function normYearStr(s){
    if(!s) return '';
    s = String(s).trim();
    if (/^\d{1,2}$/.test(s)) return s;
    if (/^\d{1,2}\s*[-/]\s*\d{1,2}$/.test(s)) return s.replace(/\s+/g,'');
    const m = s.match(/(\d{1,2})(?:\s*[-/]\s*(\d{1,2}))?/);
    return m ? (m[2] ? `${m[1]}-${m[2]}` : m[1]) : s;
  }
  function yearMatches(yearOwner, key){
    const y = String(yearOwner||'').trim();
    const k = String(key||'').trim().replace(/\s+/g,'');
    if (k.includes('-') || k.includes('/')){
      const parts = k.split(/[-/]/);
      return parts.includes(y);
    }
    return y === k;
  }
  function buildDescriptionIndex(stalls_meta){
    const byStall = new Map();
    const byYear  = new Map();
    for (const row of (stalls_meta||[])){
      const stall = row.stall || '';
      const desc  = row.description || '';
      // first column changed to year groups (e.g., "7","8","12-13")
      const key = normYearStr(row.year_stall || row.year_group_owner || row['Year-Stall']);
      if (key && desc) byYear.set(key, desc);
      if (stall && desc) byStall.set(stall, desc);
    }
    return { byStall, byYear };
  }
  function lookupDescriptionForSelectedStall(index){
    if (!current.stall) return '';
    if (index.byStall.has(current.stall)) return index.byStall.get(current.stall);
    const row = (meta.stalls_meta||[]).find(x => x.stall === current.stall);
    const stallYear = normYearStr(row && (row.year_group_owner || row.year_stall || row['Year-Stall']));
    if (!stallYear) return '';
    for (const [key, text] of index.byYear.entries()){
      if (yearMatches(stallYear, key)) return text;
    }
    return '';
  }
  let descIndex = { byStall:new Map(), byYear:new Map() };

  function renderStallDesc(){
    if(!current.stall){
      stallDesc.textContent = 'Choose a year-group stall to see details here.';
      return;
    }
    const txt = lookupDescriptionForSelectedStall(descIndex);
    stallDesc.textContent = txt || 'No description yet.';
  }

  async function loadMeta(){
    const data=await fetchJSON(`${API_BASE}?action=meta`);
    if(!data.ok){ showDebug('Meta error: ' + (data.error||'unknown')); return; }
    meta=data;

    descIndex = buildDescriptionIndex(meta.stalls_meta);

    // single-select chips
    stallChips.innerHTML = (meta.stalls||[]).map(s=>`<span class="chip" data-stall="${s}">${s}</span>`).join('');
    stallChips.addEventListener('click',(e)=>{
      const chip=e.target.closest('.chip'); if(!chip) return;
      const s=chip.dataset.stall;
      const wasActive = chip.classList.contains('active');
      stallChips.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
      if (wasActive) { current.stall = ''; }
      else { chip.classList.add('active'); current.stall = s; }
      renderStallDesc();
      loadGroups();
    });

    // Time dropdown
    const times=data.times||[];
    timeSelect.innerHTML = `<option value="">All times</option>` + times.map(t=>`<option value="${t}">${t}</option>`).join('');
    timeSelect.addEventListener('change',()=>{ current.time=timeSelect.value; loadGroups(); });

    // Class dropdown â€” mandatory
    childClass.innerHTML = `<option value="">â€” Select class â€”</option>` + CLASS_ORDER.map(c=>`<option value="${c}">${c}</option>`).join('');

    renderStallDesc();
  }

  async function loadGroups(){
    const loadingNode = document.getElementById('loading');
    if (loadingNode) loadingNode.style.display='block';
    const params=new URLSearchParams();
    params.set('action','slots');
    if(current.stall) params.set('stall', current.stall);
    if(current.time) params.set('time', current.time);
    if(current.open) params.set('open','1');

    const data=await fetchJSON(`${API_BASE}?${params.toString()}`);
    if(!data.ok){ showDebug('Slots error: ' + (data.error||'unknown')); groups=[]; render(); if(loadingNode) loadingNode.style.display='none'; return; }
    groups=data.data||[];
    render();
    if (loadingNode) loadingNode.style.display='none';
  }

  async function loadSummary(){
    const data=await fetchJSON(`${API_BASE}?action=summary`);
    if(!data.ok){ showDebug('Summary error: ' + (data.error||'unknown')); return; }
    const sum=data.data||[];
    const items=sum.map(s=>({ label:`${s.stall} (Y${s.year_group_owner})`, booked:s.booked, capacity:s.capacity, pct:s.pct }));
    const orderMap=new Map(SUMMARY_ORDER.map((lab,i)=>[lab,i]));
    items.sort((a,b)=>{
      const ia=orderMap.has(a.label)?orderMap.get(a.label):999 + a.label.localeCompare(b.label);
      const ib=orderMap.has(b.label)?orderMap.get(b.label):999 + b.label.localeCompare(a.label);
      return ia-ib;
    });
    const el=document.getElementById('summary');
    el.innerHTML=items.map(s=>{
      const pct=Math.round((s.pct||0)*100);
      return `<div style="margin:6px 0">${s.label} â€” ${s.booked}/${s.capacity}
        <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
      </div>`;
    }).join('');
  }

  function render(){
    foundCount.textContent = groups.length ? `â€” ${groups.length} roles` : '';

    const byTime=new Map();
    for(const g of groups){ if(!byTime.has(g.time)) byTime.set(g.time, []); byTime.get(g.time).push(g); }

    let html='';
    for(const [time, gg] of byTime.entries()){
      html += `<div class="timeHeader">${time||''}</div>`;
      gg.forEach(g=>{
        const sel=selection.has(g.group_id);
        const btnText=sel?'Selected':'Select';
        const canSelect = g.remaining>0 || sel;
        html += `<div class="slot" data-id="${g.group_id}">
          <div>
            <div><strong>${g.role||''}</strong></div>
            <div class="muted">${g.stall}</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px; justify-content:flex-end">
            <div class="badge"><strong>${sel ? g.remaining-1 : g.remaining}</strong> remaining</div>
            <button class="btn ${sel?'selected':''}" ${canSelect?'':'disabled'}>${btnText}</button>
          </div>
        </div>`;
      });
    }
    const target=document.getElementById('slots');
    const firstLoading = document.getElementById('loading');
    if(target){ target.innerHTML = (firstLoading? firstLoading.outerHTML : '') + html; }

    document.querySelectorAll('.slot').forEach(card=>{
      const id=card.dataset.id;
      const g=groups.find(x=>x.group_id===id);
      const btn=card.querySelector('button');
      if(!btn || !g) return;
      btn.addEventListener('click', ()=>{
        if(selection.has(id)){ selection.delete(id); }
        else if(g.remaining>0){
          const urn=g.available_urns[0];
          selection.set(id, { urn, label: `${g.year_stall}, ${g.role}, ${g.time}` });
        }
        render();
      });
    });

    const items=[...selection.values()];
    if(selectedEl){
      selectedEl.innerHTML = items.length
        ? `<ul>${items.map(it=>`<li>${it.label}</li>`).join('')}</ul>`
        : '<div class="muted">No positions selected yet.</div>';
    }

    updateConfirmState();
  }

  document.getElementById('openAll').addEventListener('change', (e)=>{ current.open=e.target.checked; loadGroups(); });

  document.getElementById('confirm').addEventListener('click', async ()=>{
    formBanner.style.display='none'; formBanner.textContent='';
    const urns=[...selection.values()].map(v=>v.urn);

    const ok = (()=>{
      const okFirst = !!firstName.value.trim(); const okLast = !!lastName.value.trim();
      const okE = isValidEmail(email.value); const okM = isValidUKMobile(mobile.value);
      const okC = !!childClass.value;
      firstName.classList.toggle('invalid', !okFirst);
      lastName.classList.toggle('invalid', !okLast);
      email.classList.toggle('invalid', !okE); emailErr.classList.toggle('show', !okE);
      mobile.classList.toggle('invalid', !okM); mobileErr.classList.toggle('show', !okM);
      childClass.classList.toggle('invalid', !okC); classErr.classList.toggle('show', !okC);
      return okFirst && okLast && okE && okM && okC;
    })();
    if(!ok || selection.size===0){
      formBanner.textContent = selection.size===0
        ? 'Please select at least one position.'
        : 'Please correct the highlighted fields.';
      formBanner.style.display='block';
      (document.querySelector('.invalid')||firstName).focus({preventScroll:false});
      updateConfirmState();
      return;
    }

    const original=confirmBtn.textContent;
    confirmBtn.textContent='Please waitâ€¦';
    confirmBtn.classList.add('wait');
    confirmBtn.disabled=true;
    msgEl.textContent='';

    const form = new URLSearchParams({
      first_name:firstName.value.trim(),
      last_name:lastName.value.trim(),
      email:email.value.trim(),
      mobile:mobile.value.trim(),
      child_class:childClass.value,
      slot_ids: urns.join(',')
    });

    try{
      const res = await fetch(API_BASE, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
        body: form.toString(),
        redirect: 'follow'
      });
      const raw = await res.text();
      let data;
      try { data = JSON.parse(raw); }
      catch { data = { ok:false, error:`HTTP ${res.status} ${res.statusText}: ${raw.slice(0,200)}` }; }

      if(!data.ok){
        const err = String(data.error||'');
        const nice = /Some positions are no longer available/i.test(err)
          ? 'Sorry, some positions are unavailable now. Select again or message your class rep to volunteer.'
          : err || 'There was an error';
        formBanner.textContent = nice;
        formBanner.style.display='block';
      }else{
        msgEl.textContent='Thank you! Please make a note of your choice. Your class rep will be in touch.';
        selection.clear();
        await Promise.all([loadGroups(), loadSummary()]);
      }
    }catch(err){
      formBanner.textContent = String(err);
      formBanner.style.display='block';
    }finally{
      confirmBtn.textContent=original;
      confirmBtn.classList.remove('wait');
      updateConfirmState();
    }
  });

  (async function(){
    if(localStorage.getItem('lms_pw_ok')!=='1'){ openGate(); return; }
    openApp();
    await loadMeta();
    await loadSummary();
    await loadGroups();
  })();
</script>
</body>
</html>
